{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}Nạp tiền | {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .qrcode-container {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px dashed #dee2e6;
    }
    .qrcode-container img {
        max-width: 100%;
        max-height: 100%;
    }
    .payment-option-card {
        transition: all 0.3s ease;
    }
    .payment-option-card:hover {
        transform: translateY(-5px);
    }
    .payment-option-card.selected {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 1px var(--primary-color);
    }
    .form-check-input[type="radio"]:checked + .form-check-label .card {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 1px var(--primary-color);
    }
    .border-dashed {
        border-style: dashed !important;
    }
    .icon-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'portfolio/js/wallet.js' %}"></script>
<!-- Use CDN for QR code library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Immediate bank section visibility
        const bankTransferSection = document.getElementById('bank_transferSection');
        if (bankTransferSection) {
            bankTransferSection.classList.remove('d-none');
        }
        
        // Wait for page to fully load
        setTimeout(initializeQRCodes, 1000);
        
        // Set up event listeners
        const amountInput = document.getElementById('amount');
        if (amountInput) {
            amountInput.addEventListener('change', updateQRCodes);
            amountInput.addEventListener('input', updateQRCodes);
            
            // Update amount display in transaction info sidebar
            amountInput.addEventListener('input', function() {
                document.querySelectorAll('.amount-display').forEach(el => {
                    el.textContent = new Intl.NumberFormat('vi-VN').format(this.value) + ' VNĐ';
                });
            });
            
            // Trigger initial amount display
            document.querySelectorAll('.amount-display').forEach(el => {
                el.textContent = new Intl.NumberFormat('vi-VN').format(amountInput.value) + ' VNĐ';
            });
        }
        
        // Handle payment method switching manually through card clicks
        const paymentCards = document.querySelectorAll('.payment-option-card');
        const paymentRadios = document.querySelectorAll('.payment-radio');
        const actualPaymentMethodInput = document.getElementById('actual_payment_method');
        
        paymentCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Find the radio button
                const radio = this.closest('.form-check').querySelector('input[type="radio"]');
                if (!radio) return;
                
                // Update hidden input with selected value
                if (actualPaymentMethodInput) {
                    actualPaymentMethodInput.value = radio.value;
                }
                
                // Update UI for all cards
                paymentCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                // Update radio button states (for UI consistency)
                paymentRadios.forEach(r => {
                    r.checked = (r === radio);
                });
                
                // Show corresponding section
                handlePaymentMethodChange(radio.value);
                
                // Update QR codes after section is visible
                setTimeout(updateQRCodes, 300);
                
                // Prevent default click behavior
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        });
        
        // Initial selection
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        if (selectedMethod) {
            selectedMethod.closest('.form-check').querySelector('.card').classList.add('selected');
            handlePaymentMethodChange(selectedMethod.value);
        } else if (paymentCards.length > 0) {
            const firstRadio = paymentCards[0].querySelector('input[type="radio"]');
            if (firstRadio) {
                firstRadio.checked = true;
                paymentCards[0].classList.add('selected');
                handlePaymentMethodChange(firstRadio.value);
            }
        }
        
        // Bank account card selection
        document.querySelectorAll('.form-check input[name="bank_account"]').forEach(radioBtn => {
            const card = radioBtn.closest('.form-check').querySelector('.card');
            
            // Add click event to the card
            if (card) {
                card.addEventListener('click', function(e) {
                    radioBtn.checked = true;
                    
                    // Update all cards UI
                    document.querySelectorAll('.form-check input[name="bank_account"]').forEach(rb => {
                        const otherCard = rb.closest('.form-check').querySelector('.card');
                        if (otherCard) {
                            if (rb.checked) {
                                otherCard.classList.add('selected');
                            } else {
                                otherCard.classList.remove('selected');
                            }
                        }
                    });
                    
                    // Toggle new bank account form
                    toggleNewBankAccountForm();
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            }
        });
        
        // Make sure bank account selection is visible on load
        const bankAccountSection = document.querySelector('.card-header h5 i.fa-university');
        if (bankAccountSection) {
            bankAccountSection.closest('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Bank name change for new account
        const bankNameSelect = document.getElementById('new_bank_name');
        if (bankNameSelect) {
            bankNameSelect.addEventListener('change', function() {
                toggleOtherBankField();
            });
        }
        
        // Initial bank account form display
        toggleNewBankAccountForm();
        toggleOtherBankField();
        
        // Show bank transfer section immediately
        showBankTransferSection();
    });
    
    function showBankTransferSection() {
        // Get the bank transfer section
        const bankTransferSection = document.getElementById('bank_transferSection');
        if (bankTransferSection) {
            // Make sure it's visible
            bankTransferSection.classList.remove('d-none');
            console.log("Hiển thị phần chuyển khoản ngân hàng");
            
            // If there's a bank transfer radio button, mark it as selected
            const bankTransferRadio = document.getElementById('bankTransfer');
            if (bankTransferRadio) {
                bankTransferRadio.checked = true;
                
                // Update UI for all payment methods
                document.querySelectorAll('.payment-option-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Update the hidden form field
                const actualPaymentMethodInput = document.getElementById('actual_payment_method');
                if (actualPaymentMethodInput) {
                    actualPaymentMethodInput.value = 'bank_transfer';
                }
                
                // Update the UI for the selected card
                const selectedCard = bankTransferRadio.closest('.form-check').querySelector('.card');
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
            }
        }
    }
    
    function toggleNewBankAccountForm() {
        const newBankRadio = document.getElementById('newBankAccount');
        const newBankForm = document.getElementById('newBankAccountForm');
        
        if (newBankRadio && newBankForm) {
            if (newBankRadio.checked) {
                newBankForm.classList.remove('d-none');
            } else {
                newBankForm.classList.add('d-none');
            }
        }
    }
    
    function toggleOtherBankField() {
        const bankNameSelect = document.getElementById('new_bank_name');
        const otherBankGroup = document.getElementById('otherBankGroup');
        
        if (bankNameSelect && otherBankGroup) {
            if (bankNameSelect.value === 'other') {
                otherBankGroup.classList.remove('d-none');
            } else {
                otherBankGroup.classList.add('d-none');
            }
        }
    }
    
    function initializeQRCodes() {
        console.log("Initializing QR codes...");
        createQRContainer('bankTransferQR');
        createQRContainer('momoQR');
        createQRContainer('vnpayQR');
        updateQRCodes();
    }
    
    function createQRContainer(id) {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = '';
            container.classList.add('qrcode-container');
        }
    }
    
    function updateQRCodes() {
        try {
            console.log("Updating QR codes...");
            generateBankTransferQR();
            generateMomoQR();
            generateVNPayQR();
        } catch (error) {
            console.error("Error generating QR codes:", error);
        }
    }
    
    function handlePaymentMethodChange(method) {
        console.log("Payment method changed to:", method);
        
        // Hide all payment sections
        const sections = document.querySelectorAll('.payment-section');
        sections.forEach(section => section.classList.add('d-none'));
        
        // Show selected section
        const selectedSection = document.getElementById(method + 'Section');
        if (selectedSection) {
            selectedSection.classList.remove('d-none');
            console.log("Showing section:", method + 'Section');
        } else {
            console.error("Section not found:", method + 'Section');
        }
        
        // Toggle required fields
        toggleRequiredFields(method);
    }
    
    function toggleRequiredFields(method) {
        const fullNameField = document.getElementById('fullName');
        const emailField = document.getElementById('email');
        
        if (fullNameField && emailField) {
            if (method === 'vnpay') {
                fullNameField.disabled = false;
                emailField.disabled = false;
                fullNameField.required = true;
                emailField.required = true;
            } else {
                fullNameField.disabled = true;
                emailField.disabled = true;
                fullNameField.required = false;
                emailField.required = false;
            }
        }
    }
    
    function generateBankTransferQR() {
        try {
            const amount = document.getElementById('amount')?.value || 100000;
            const username = '{{ request.user.username }}';
            // Make QR content shorter to avoid overflow
            const qrContent = `TCB|19033868888016|NAP ${username}|${amount}`;
            
            generateQR('bankTransferQR', qrContent, "#000000");
        } catch (error) {
            console.error("Error in bank transfer QR:", error);
            showQRError('bankTransferQR');
        }
    }
    
    function generateMomoQR() {
        try {
            const amount = document.getElementById('amount')?.value || 100000;
            const username = '{{ request.user.username }}';
            // Make QR content shorter
            const qrContent = `MOMO|0987654321|NAP ${username}|${amount}`;
            
            generateQR('momoQR', qrContent, "#ae2070");
        } catch (error) {
            console.error("Error in MoMo QR:", error);
            showQRError('momoQR');
        }
    }
    
    function generateVNPayQR() {
        try {
            const amount = document.getElementById('amount')?.value || 100000;
            const username = '{{ request.user.username }}';
            // Make QR content shorter
            const qrContent = `VNPAY|NAP ${username}|${amount}`;
            
            generateQR('vnpayQR', qrContent, "#004a9c");
        } catch (error) {
            console.error("Error in VNPay QR:", error);
            showQRError('vnpayQR');
        }
    }
    
    function showQRError(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="text-danger p-3 text-center">Unable to generate QR code</div>';
        }
    }
    
    function generateQR(containerId, content, color) {
        try {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            if (typeof QRCode === 'undefined') {
                console.error("QRCode library not loaded");
                container.innerHTML = '<div class="text-danger p-3">QR code library not loaded</div>';
                return;
            }
            
            new QRCode(container, {
                text: content,
                width: 180,
                height: 180,
                colorDark: color || "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            console.log(containerId + ' QR generated successfully');
        } catch (error) {
            console.error("Error generating QR for " + containerId, error);
            container.innerHTML = '<div class="text-danger p-3 text-center">Error: ' + error.message + '</div>';
        }
    }
    
    function downloadQR(elementId) {
        const canvas = document.querySelector(`#${elementId} canvas`);
        if (!canvas) {
            alert('QR code not available for download');
            return;
        }
        
        try {
            const link = document.createElement('a');
            link.download = `qrcode-payment-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
            link.click();
        } catch (error) {
            console.error("Error downloading QR", error);
            alert('Unable to download QR code');
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4" data-aos="fade-right">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Bảng điều khiển</a></li>
            <li class="breadcrumb-item"><a href="{% url 'wallet' %}">Ví điện tử</a></li>
            <li class="breadcrumb-item active">Nạp tiền</li>
        </ol>
    </nav>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} rounded-4 mb-4">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="alert-heading">Thông báo</h6>
                        <p class="mb-0">{{ message|safe }}</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 mb-4" data-aos="fade-up">
                <div class="card-header border-0 p-4">
                    <div class="card-heading">
                        <div class="card-heading-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <h4 class="mb-0">Nạp tiền vào tài khoản</h4>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="depositForm" action="{% url 'deposit_money' %}" novalidate>
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger rounded-4 mb-4">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading">Lỗi xử lý form</h6>
                                    <ul class="mb-0">
                                        {% for field in form %}
                                            {% for error in field.errors %}
                                                <li>{{ field.label }}: {{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-4">
                            <label for="amount" class="form-label">Số tiền muốn nạp <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="amount" class="form-control form-control-lg" id="amount" min="50000" step="10000" value="{{ form.amount.value|default:'100000' }}" required>
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <div class="form-text">Số tiền tối thiểu: 50,000 VNĐ</div>
                        </div>
                        
                        <!-- Form hidden field for actual payment method value -->
                        <input type="hidden" id="actual_payment_method" name="payment_method" value="{{ form.payment_method.value|default:'bank_transfer' }}">

                        <h5 class="mb-3">Chọn phương thức thanh toán</h5>
                        
                        <div class="mb-4">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input payment-radio" type="radio" id="bankTransfer" value="bank_transfer" {% if form.payment_method.value == 'bank_transfer' or not form.payment_method.value %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="bankTransfer">
                                            <div class="card payment-option-card border shadow-sm rounded-4 p-3 {% if form.payment_method.value == 'bank_transfer' or not form.payment_method.value %}selected{% endif %}">
                                                <div class="d-flex align-items-center">
                                                    <div class="icon-circle bg-primary-light text-primary me-3">
                                                        <i class="fas fa-university"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1">Chuyển khoản</h6>
                                                        <div class="small text-muted">Miễn phí</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input payment-radio" type="radio" id="momoPayment" value="momo" {% if form.payment_method.value == 'momo' %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="momoPayment">
                                            <div class="card payment-option-card border shadow-sm rounded-4 p-3 {% if form.payment_method.value == 'momo' %}selected{% endif %}">
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3">
                                                        <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" width="32" height="32">
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1">MoMo</h6>
                                                        <div class="small text-muted">Ví điện tử</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input payment-radio" type="radio" id="vnpayPayment" value="vnpay" {% if form.payment_method.value == 'vnpay' %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="vnpayPayment">
                                            <div class="card payment-option-card border shadow-sm rounded-4 p-3 {% if form.payment_method.value == 'vnpay' %}selected{% endif %}">
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3">
                                                        <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/9/06ncktiwd6dc1694418196384.png" alt="VNPay" width="32" height="32">
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1">VNPay</h6>
                                                        <div class="small text-muted">QR Payment</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Transfer Section -->
                        <div id="bank_transferSection" class="payment-section mb-4">
                            <div class="alert alert-info rounded-4 mb-4">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="alert-heading">Hướng dẫn chuyển khoản</h6>
                                        <p>Vui lòng chuyển khoản đến thông tin tài khoản dưới đây:</p>
                                        <div class="card bg-light rounded-4 p-3 mb-3">
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <div class="small text-muted">Ngân hàng:</div>
                                                    <div class="fw-bold">Techcombank</div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="small text-muted">Chủ tài khoản:</div>
                                                    <div class="fw-bold">CÔNG TY CP CHỨNG KHOÁN ...</div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="small text-muted">Số tài khoản:</div>
                                                    <div class="fw-bold text-monospace">999999999999</div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="small text-muted">Chi nhánh:</div>
                                                    <div class="fw-bold">Hồ Chí Minh</div>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="mb-0">Nội dung chuyển khoản: <span class="fw-bold">NAP {{ request.user.username }}</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code for Bank Transfer -->
                            <div class="text-center mb-4">
                                <h6 class="mb-2">Quét mã QR để chuyển khoản nhanh</h6>
                                <div id="bankTransferQR" class="mx-auto mb-2"></div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadQR('bankTransferQR')">
                                    <i class="fas fa-download me-1"></i>Tải mã QR
                                </button>
                            </div>
                            
                            <!-- Bank Account Selection -->
                            <div class="card border-0 shadow-sm rounded-4 mb-4">
                                <div class="card-header bg-transparent p-4">
                                    <h5 class="mb-0">
                                        <i class="fas fa-university me-2"></i> 
                                        Tài khoản ngân hàng
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <label class="form-label">Chọn tài khoản ngân hàng hoặc thêm tài khoản mới</label>
                                        
                                        {% if form.bank_account.field.queryset.exists %}
                                        <div class="row g-3 mb-4">
                                            {% for account in form.bank_account.field.queryset %}
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input visually-hidden" 
                                                           type="radio" 
                                                           name="bank_account" 
                                                           id="account_{{ account.id }}" 
                                                           value="{{ account.id }}"
                                                           {% if form.bank_account.value|stringformat:"s" == account.id|stringformat:"s" %}checked{% elif account.is_default and not form.bank_account.value %}checked{% endif %}>
                                                    <label class="form-check-label w-100" for="account_{{ account.id }}">
                                                        <div class="card border shadow-sm rounded-4 p-3 {% if form.bank_account.value|stringformat:"s" == account.id|stringformat:"s" or account.is_default and not form.bank_account.value %}selected{% endif %}">
                                                            <div class="d-flex align-items-center">
                                                                <div class="icon-circle me-3">
                                                                    <i class="fas fa-university"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-1">
                                                                        {% if account.bank_name == 'other' %}
                                                                            {{ account.other_bank_name }}
                                                                        {% else %}
                                                                            {{ account.get_bank_name_display }}
                                                                        {% endif %}
                                                                    </h6>
                                                                    <div class="text-muted small">Chủ tài khoản: {{ account.account_name }}</div>
                                                                    <div class="text-monospace small">Số tài khoản: {{ account.account_number }}</div>
                                                                    {% if account.is_default %}
                                                                    <div class="mt-1">
                                                                        <span class="badge bg-primary">Mặc định</span>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input visually-hidden" 
                                                           type="radio" 
                                                           name="bank_account" 
                                                           id="newBankAccount" 
                                                           value="new"
                                                           {% if form.bank_account.value == 'new' %}checked{% endif %}>
                                                    <label class="form-check-label w-100" for="newBankAccount">
                                                        <div class="card border border-dashed shadow-sm rounded-4 p-3 text-center {% if form.bank_account.value == 'new' %}selected{% endif %}">
                                                            <div class="py-3">
                                                                <i class="fas fa-plus-circle fa-2x text-primary mb-2"></i>
                                                                <h6 class="mb-0">Thêm tài khoản mới</h6>
                                                                <p class="small text-muted mb-0">Nhập thông tin tài khoản mới</p>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info rounded-4 mb-3">
                                            <div class="d-flex">
                                                <div class="me-3">
                                                    <i class="fas fa-info-circle"></i>
                                                </div>
                                                <div>
                                                    <p class="mb-0">Bạn chưa có tài khoản ngân hàng nào. Vui lòng thêm tài khoản mới bên dưới.</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- New Bank Account Form -->
                                        <div id="newBankAccountForm" class="{% if form.bank_account.field.queryset.exists and form.bank_account.value != 'new' and not form.new_bank_name.errors %}d-none{% endif %}">
                                            <div class="card border border-dashed p-3 mb-3">
                                                <h6 class="mb-3">Thông tin tài khoản mới</h6>
                                                
                                                <div class="mb-3">
                                                    <label for="new_bank_name" class="form-label">Ngân hàng <span class="text-danger">*</span></label>
                                                    <select name="new_bank_name" id="new_bank_name" class="form-select">
                                                        <option value="">-- Chọn ngân hàng --</option>
                                                        {% for value, text in form.fields.new_bank_name.choices %}
                                                            <option value="{{ value }}" {% if form.new_bank_name.value == value %}selected{% endif %}>{{ text }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    {% if form.new_bank_name.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.new_bank_name.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-3 {% if form.new_bank_name.value != 'other' %}d-none{% endif %}" id="otherBankGroup">
                                                    <label for="new_other_bank_name" class="form-label">Tên ngân hàng khác <span class="text-danger">*</span></label>
                                                    <input type="text" name="new_other_bank_name" id="new_other_bank_name" class="form-control" value="{{ form.new_other_bank_name.value|default:'' }}">
                                                    {% if form.new_other_bank_name.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.new_other_bank_name.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="new_account_name" class="form-label">Chủ tài khoản <span class="text-danger">*</span></label>
                                                    <input type="text" name="new_account_name" id="new_account_name" class="form-control" value="{{ form.new_account_name.value|default:'' }}">
                                                    {% if form.new_account_name.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.new_account_name.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="new_account_number" class="form-label">Số tài khoản <span class="text-danger">*</span></label>
                                                    <input type="text" name="new_account_number" id="new_account_number" class="form-control" value="{{ form.new_account_number.value|default:'' }}">
                                                    {% if form.new_account_number.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.new_account_number.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="new_branch" class="form-label">Chi nhánh</label>
                                                    <input type="text" name="new_branch" id="new_branch" class="form-control" value="{{ form.new_branch.value|default:'' }}">
                                                    {% if form.new_branch.errors %}
                                                    <div class="text-danger small mt-1">
                                                        {% for error in form.new_branch.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="new_is_default" id="new_is_default" {% if form.new_is_default.value %}checked{% endif %}>
                                                    <label class="form-check-label" for="new_is_default">
                                                        Đặt làm tài khoản mặc định
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmTransfer" name="confirm_transfer" required {% if form.confirm_transfer.value %}checked{% endif %}>
                            <label class="form-check-label" for="confirmTransfer">
                                Tôi đã hoàn tất chuyển khoản theo hướng dẫn
                            </label>
                            {% if form.confirm_transfer.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.confirm_transfer.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- MoMo Section -->
                        <div id="momoSection" class="payment-section mb-4 d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-info rounded-4">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="alert-heading">Hướng dẫn thanh toán MoMo</h6>
                                                <ol class="mb-0">
                                                    <li>Mở ứng dụng MoMo trên điện thoại</li>
                                                    <li>Chọn "Quét mã" và quét mã QR bên cạnh</li>
                                                    <li>Nhập số tiền: <span class="amount-display fw-bold">0</span></li>
                                                    <li>Nhập tin nhắn: <span class="fw-bold">NAP {{ request.user.username }}</span></li>
                                                    <li>Xác nhận thanh toán</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 text-center">
                                    <h6 class="mb-3">Quét mã QR để thanh toán qua MoMo</h6>
                                    <div id="momoQR" class="mx-auto mb-3"></div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadQR('momoQR')">
                                        <i class="fas fa-download me-1"></i>Tải mã QR
                                    </button>
                                    <p class="text-muted small mt-2">Mã QR có hiệu lực trong 15 phút</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- VNPay Section -->
                        <div id="vnpaySection" class="payment-section mb-4 d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-info rounded-4">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="alert-heading">Hướng dẫn thanh toán VNPay</h6>
                                                <ol class="mb-0">
                                                    <li>Mở ứng dụng ngân hàng có hỗ trợ VNPay</li>
                                                    <li>Chọn tính năng "Quét mã QR"</li>
                                                    <li>Quét mã QR bên cạnh</li>
                                                    <li>Xác nhận thanh toán <span class="amount-display fw-bold">0</span></li>
                                                    <li>Hoàn tất giao dịch</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="fullName" class="form-label">Họ tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fullName" name="fullname" value="{{ form.fullname.value|default:'' }}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="email" name="email" value="{{ form.email.value|default:'' }}">
                                    </div>
                                </div>
                                
                                <div class="col-md-6 text-center">
                                    <h6 class="mb-3">Quét mã QR để thanh toán qua VNPay</h6>
                                    <div id="vnpayQR" class="mx-auto mb-3"></div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadQR('vnpayQR')">
                                        <i class="fas fa-download me-1"></i>Tải mã QR
                                    </button>
                                    <p class="text-muted small mt-2">Mã QR có hiệu lực trong 15 phút</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" name="agree_terms" required {% if form.agree_terms.value %}checked{% endif %}>
                            <label class="form-check-label" for="agreeTerms">
                                Tôi đồng ý với <a href="#" class="text-primary">điều khoản nạp tiền</a> của StockPortfolio
                            </label>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg btn-rounded">
                                <i class="fas fa-check-circle me-2"></i>Xác nhận nạp tiền
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 mb-4 sticky-lg-top" style="top: 100px;" data-aos="fade-up" data-aos-delay="100">
                <div class="card-header bg-primary-light p-4 border-0">
                    <div class="card-heading">
                        <div class="card-heading-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h5 class="mb-0">Thông tin giao dịch</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Số tiền nạp:</span>
                            <span class="fw-bold amount-display">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Phí giao dịch:</span>
                            <span class="fw-bold text-success">Miễn phí</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span class="text-muted">Tổng tiền:</span>
                            <span class="fw-bold amount-display">0</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning rounded-4 mb-4">
                        <div class="d-flex">
                            <div class="me-2">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                            <div class="small">
                                <strong>Thời gian xử lý:</strong>
                                <p class="mb-0">Giao dịch MoMo/VNPay được xử lý ngay lập tức. Giao dịch chuyển khoản ngân hàng được xử lý trong vòng 24 giờ làm việc.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success rounded-4 mb-0">
                        <div class="d-flex">
                            <div class="me-2">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="small">
                                <strong>Giao dịch an toàn</strong>
                                <p class="mb-0">Thông tin của bạn được bảo mật và giao dịch được mã hóa an toàn.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}